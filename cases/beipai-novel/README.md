# æ¡ˆä¾‹ï¼šåŒ—æ´¾ç›—å¢“ç¬”è®°

æœ¬æ¡ˆä¾‹å±•ç¤ºå¦‚ä½•ä»å°è¯´ã€ŠåŒ—æ´¾ç›—å¢“ç¬”è®°ã€‹ä¸­æŠ½å–åœ°ç‚¹ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆ Geolore å†…å®¹åŒ…ã€‚

## ğŸ“Š é¡¹ç›®æ¦‚å†µ

| é¡¹ç›® | æ•°å€¼ |
|------|------|
| å°è¯´åç§° | åŒ—æ´¾ç›—å¢“ç¬”è®° |
| åŸæ–‡å­—æ•° | ~100ä¸‡å­— |
| ç« èŠ‚æ•° | ~1700ç«  |
| åˆ†ç‰‡æ•° | 872ä¸ª |
| æœ€ç»ˆåœ°ç‚¹æ•° | 942ä¸ª |
| æ•°æ®æº | é«˜å¾·åœ°å›¾ API |

## ğŸ“ ç›®å½•ç»“æ„

```
åŒ—æ´¾ç›—å¢“ç¬”è®°/
â”œâ”€â”€ 00_åŸå§‹å°è¯´/
â”‚   â””â”€â”€ åŒ—æ´¾ç›—å¢“ç¬”è®°.utf8.txt      # UTF-8 ç¼–ç çš„åŸæ–‡
â”œâ”€â”€ 01_åˆ†ç‰‡/
â”‚   â”œâ”€â”€ chunk_001.txt ~ chunk_872.txt
â”‚   â””â”€â”€ index.json
â”œâ”€â”€ 02_AIåˆ†æ/
â”‚   â”œâ”€â”€ prompts.jsonl              # LLM æç¤ºè¯
â”‚   â”œâ”€â”€ extract_places.jsonl       # æŠ½å–ç»“æœ
â”‚   â””â”€â”€ æå–æ•°æ®prompt.md          # è‡ªå®šä¹‰æç¤ºè¯
â”œâ”€â”€ 03_AIæ±‡æ€»/
â”‚   â”œâ”€â”€ extract_places_merged_by_title.json
â”‚   â”œâ”€â”€ cleaned_places.json
â”‚   â”œâ”€â”€ cleaned_places.filtered.json  # æœ€ç»ˆæ¸…æ´—ç»“æœ
â”‚   â””â”€â”€ æ¸…æ´—æ•°æ®prompt.md
â”œâ”€â”€ 04_åœ°ç‚¹è§£æ/
â”‚   â”œâ”€â”€ cleaned_places.filtered.geocoded.amap.json
â”‚   â””â”€â”€ logs/
â””â”€â”€ 05_å†…å®¹åŒ…/
    â””â”€â”€ beipai-pack.v5.json        # æœ€ç»ˆå†…å®¹åŒ…
```

## ğŸ”§ å®Œæ•´å¤„ç†æµç¨‹

### é˜¶æ®µ 1ï¼šæ–‡æœ¬åˆ†ç‰‡

```bash
cd åŒ—æ´¾ç›—å¢“ç¬”è®°

# æŒ‰ç« èŠ‚åˆ†ç‰‡ï¼ˆæ¯2ç« ä¸€ä¸ªåˆ†ç‰‡ï¼‰
python scripts/split_chapters.py \
  --text "00_åŸå§‹å°è¯´/åŒ—æ´¾ç›—å¢“ç¬”è®°.utf8.txt" \
  --out-dir "01_åˆ†ç‰‡" \
  --per-chunk 2
```

**ç»“æœ**ï¼šç”Ÿæˆ 872 ä¸ªåˆ†ç‰‡æ–‡ä»¶

### é˜¶æ®µ 2ï¼šAI åœ°ç‚¹æŠ½å–

```bash
# ç”Ÿæˆæç¤ºè¯
python scripts/gen_llm_prompts.py \
  --chunks-dir "01_åˆ†ç‰‡" \
  --output-jsonl "02_AIåˆ†æ/prompts.jsonl"

# è¿è¡Œ LLM æŠ½å–
export OPENAI_API_KEY="your-key"
python scripts/batch_extract_places.py \
  --system-file "02_AIåˆ†æ/æå–æ•°æ®prompt.md" \
  --chunks-dir "01_åˆ†ç‰‡" \
  --output "02_AIåˆ†æ/extract_places.jsonl" \
  --api-key "$OPENAI_API_KEY"
```

**è‡ªå®šä¹‰æç¤ºè¯**ï¼ˆ02_AIåˆ†æ/æå–æ•°æ®prompt.mdï¼‰ï¼š
```markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡æ¯æŠ½å–åŠ©æ‰‹ã€‚è¯·ä»ç»™å®šçš„ç›—å¢“ç¬”è®°å°è¯´æ–‡æœ¬ä¸­æŠ½å–ï¼š

1. åœ°ç‚¹ä¿¡æ¯
   - å…·ä½“åœ°åï¼ˆåŸå¸‚ã€è¡—é“ã€å»ºç­‘ã€å±±è„‰ã€æ²³æµç­‰ï¼‰
   - å°½é‡ä¿ç•™åŸæ–‡æè¿°
   - ç»™å‡ºæ‰€åœ¨çœä»½/åŸå¸‚ä¿¡æ¯

2. è¾“å‡ºæ ¼å¼
   - æ¯ä¸ªåœ°ç‚¹åŒ…å«ï¼šname, address, synopsis, quote
   - address æ ¼å¼ï¼šçœ-å¸‚-åŒº-å…·ä½“åœ°ç‚¹
   - synopsisï¼šè¯¥åœ°ç‚¹åœ¨å°è¯´ä¸­çš„ä½œç”¨/å‘ç”Ÿçš„äº‹ä»¶
```

### é˜¶æ®µ 3ï¼šæ•°æ®æ¸…æ´—ä¸åˆå¹¶

```bash
# æŒ‰æ ‡é¢˜åˆå¹¶åŒååœ°ç‚¹
python scripts/merge_places_by_title.py \
  --input-jsonl "02_AIåˆ†æ/extract_places.jsonl" \
  --output-json "03_AIæ±‡æ€»/extract_places_merged_by_title.json"

# LLM è¾…åŠ©æ¸…æ´—ï¼ˆåˆå¹¶ synopsisï¼Œæ ‡å‡†åŒ–åœ°å€ï¼‰
python scripts/clean_synopsis_batches.py \
  --system-file "03_AIæ±‡æ€»/æ¸…æ´—æ•°æ®prompt.md" \
  --input-json "03_AIæ±‡æ€»/extract_places_merged_by_title.json" \
  --output-json "03_AIæ±‡æ€»/cleaned_places.json" \
  --api-key "$OPENAI_API_KEY"

# è¿‡æ»¤é—®é¢˜æ•°æ®
python scripts/filter_cleaned_places.py \
  --input "03_AIæ±‡æ€»/cleaned_places.json" \
  --output "03_AIæ±‡æ€»/cleaned_places.filtered.json"
```

**è¿‡æ»¤è§„åˆ™**ï¼š
- ç§»é™¤åœ°å€åŒ…å«"æœªæä¾›"çš„æ¡ç›®
- ç§»é™¤åœ°å€åŒ…å« 2 ä¸ªåŠä»¥ä¸Š"æŸ"å­—çš„æ¡ç›®
- ç§»é™¤"ä¸­å›½-æŸ"å¼€å¤´çš„æ¨¡ç³Šåœ°å€

**æ¸…æ´—å‰åå¯¹æ¯”**ï¼š
| é˜¶æ®µ | åœ°ç‚¹æ•° |
|------|--------|
| åŸå§‹æŠ½å– | ~1500 |
| åˆå¹¶å | ~1100 |
| æ¸…æ´—å | 948 |
| è¿‡æ»¤å | 942 |

### é˜¶æ®µ 4ï¼šåœ°ç†ç¼–ç 

```bash
# ä½¿ç”¨é«˜å¾·åœ°å›¾ API ç¼–ç 
export AMAP_KEY="your-amap-key"
python scripts/geocode_cleaned_places.py \
  --input "03_AIæ±‡æ€»/cleaned_places.filtered.json" \
  --output "04_åœ°ç‚¹è§£æ/cleaned_places.filtered.geocoded.amap.json" \
  --provider amap \
  --amap-key "$AMAP_KEY" \
  --enable-validation \
  --log "04_åœ°ç‚¹è§£æ/logs/geocode_run.log"
```

**ç¼–ç ç­–ç•¥**ï¼š
1. åˆ†çº§å›é€€ï¼šä»å®Œæ•´åœ°å€å¼€å§‹ï¼Œé€çº§å‘ä¸Šå›é€€
2. ç»“æœéªŒè¯ï¼šæ£€æŸ¥è¡Œæ”¿åŒºä¸€è‡´æ€§å’Œåæ ‡è·ç¦»
3. ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è¯·æ±‚

**ç¼–ç ç»“æœ**ï¼š
| æŒ‡æ ‡ | å€¼ |
|------|------|
| æ€»åœ°ç‚¹ | 942 |
| ç¼–ç æˆåŠŸ | 942 (100%) |
| éªŒè¯é€šè¿‡ | 938 (99.6%) |
| å¸¦æ ¼å¼åŒ–åœ°å€ | 942 (100%) |

### é˜¶æ®µ 5ï¼šç”Ÿæˆå†…å®¹åŒ…

```bash
python scripts/build_pack_from_candidates.py \
  --input "04_åœ°ç‚¹è§£æ/cleaned_places.filtered.geocoded.amap.json" \
  --output "05_å†…å®¹åŒ…/beipai-pack.v5.json" \
  --pack-id "beipai-notes" \
  --pack-title "åŒ—æ´¾ç›—å¢“ç¬”è®°åœ°å›¾" \
  --pack-version 5
```

### éƒ¨ç½²åˆ° iOS åº”ç”¨

```bash
# å¤åˆ¶åˆ° Resources ç›®å½•
cp "05_å†…å®¹åŒ…/beipai-pack.v5.json" \
   "geolore/Resources/beipai-pack.from-amap.json"
```

## ğŸ“¦ æœ€ç»ˆå†…å®¹åŒ…ç¤ºä¾‹

```json
{
  "schemaVersion": 1,
  "pack": {
    "id": "beipai-notes",
    "version": 5,
    "title": "åŒ—æ´¾ç›—å¢“ç¬”è®°åœ°å›¾",
    "locale": "zh-Hans",
    "applyMode": "replace"
  },
  "map": {
    "title": "åŒ—æ´¾ç›—å¢“ç¬”è®°"
  },
  "places": [
    {
      "clientId": "geocoded-abc123",
      "title": "åŒ—äº¬è¥¿ç«™",
      "latitude": 39.8948,
      "longitude": 116.3215,
      "locality": "åŒ—äº¬å¸‚",
      "countryCode": "CN",
      "formattedAddress": "åŒ—äº¬å¸‚æµ·æ·€åŒºè²èŠ±æ± ä¸œè·¯118å·",
      "synopsis": "ä¸»è§’ä¹˜ç«è½¦å‰å¾€é•¿æ²™çš„å‡ºå‘ç‚¹ï¼Œåœ¨è¿™é‡Œä¸é˜Ÿå‹æ±‡åˆ..."
    }
  ],
  "mapPlaces": [
    {
      "placeClientId": "geocoded-abc123",
      "orderIndex": 1,
      "note": "ä¸»è§’ä¹˜ç«è½¦å‰å¾€é•¿æ²™çš„å‡ºå‘ç‚¹..."
    }
  ],
  "tags": ["curated", "æ–‡å­¦", "ç›—å¢“", "pack:beipai-notes@5"]
}
```

## ğŸ“Š æ•°æ®è´¨é‡æŠ¥å‘Š

### åœ°ç†è¦†ç›–
- **çº¬åº¦èŒƒå›´**: 18.24Â° ~ 53.49Â°ï¼ˆä»æµ·å—åˆ°é»‘é¾™æ±Ÿï¼‰
- **ç»åº¦èŒƒå›´**: 91.12Â° ~ 130.39Â°ï¼ˆä»è¥¿è—åˆ°é»‘é¾™æ±Ÿï¼‰
- **è¦†ç›–çœä»½**: 30+ çœä»½/ç›´è¾–å¸‚/è‡ªæ²»åŒº

### åœ°ç‚¹ç±»å‹åˆ†å¸ƒ
| ç±»å‹ | æ•°é‡ | æ¯”ä¾‹ |
|------|------|------|
| åŸå¸‚/åŒºå¿ | 312 | 33% |
| è¡—é“/è·¯å | 198 | 21% |
| POIï¼ˆå»ºç­‘/æ™¯ç‚¹ï¼‰ | 287 | 30% |
| å±±è„‰/æ²³æµ | 89 | 9% |
| å…¶ä»– | 56 | 6% |

### æ•°æ®å®Œæ•´æ€§
| å­—æ®µ | å®Œæ•´ç‡ |
|------|--------|
| title | 100% |
| latitude/longitude | 100% |
| formattedAddress | 100% |
| locality | 91.4% |
| synopsis | 100% |

## ğŸ”‘ å…³é”®ç»éªŒ

### 1. æ–‡æœ¬åˆ†ç‰‡ç­–ç•¥
- æ¯ä¸ªåˆ†ç‰‡ 2 ç« æ•ˆæœæœ€å¥½
- å¤ªå¤§å®¹æ˜“è¶…å‡º token é™åˆ¶
- å¤ªå°ä¼šä¸¢å¤±ä¸Šä¸‹æ–‡

### 2. åœ°å€æ ‡å‡†åŒ–
æ ‡å‡†æ ¼å¼ï¼š`çœ-å¸‚-åŒº-è¡—é“-å…·ä½“åœ°ç‚¹`

ç¤ºä¾‹ï¼š
- âœ… `åŒ—äº¬å¸‚-æµ·æ·€åŒº-ä¸­å…³æ‘å¤§è¡—-æ¸…åå¤§å­¦`
- âŒ `æ¸…åå¤§å­¦`
- âŒ `åŒ—äº¬æ¸…å`

### 3. åœ°ç†ç¼–ç ä¼˜åŒ–
- ä½¿ç”¨åˆ†çº§å›é€€é¿å…æ­§ä¹‰
- å¯ç”¨éªŒè¯é˜²æ­¢é”™è¯¯åŒ¹é…
- ç¼“å­˜ç»“æœé¿å…é‡å¤è¯·æ±‚

### 4. æ•°æ®æ¸…æ´—è¦ç‚¹
- åˆå¹¶åŒååœ°ç‚¹çš„ synopsis
- è¿‡æ»¤æ¨¡ç³Š/æ— æ•ˆåœ°å€
- äººå·¥å®¡æ ¸å¼‚å¸¸æ•°æ®

## ğŸ“š ç›¸å…³æ–‡ä»¶

- [å®Œæ•´ SOP æ–‡æ¡£](../docs/SOP.md)
- [åœ°ç†ç¼–ç è§„åˆ™](../docs/GeocodingRules.md)
- [å†…å®¹åŒ…è§„èŒƒ](../docs/ContentPackSpec.md)
