# å°è¯´åœ°ç‚¹æŠ½å– SOPï¼ˆæ ‡å‡†æ“ä½œæµç¨‹ï¼‰

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•ä»ä¸€éƒ¨å°è¯´ä¸­æŠ½å–åœ°ç‚¹ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆå¯åœ¨ Geolore iOS åº”ç”¨ä¸­ä½¿ç”¨çš„å†…å®¹åŒ…ã€‚

## ğŸ“‹ æ¦‚è¿°

### é€‚ç”¨åœºæ™¯
- æ–‡å­¦ä½œå“ï¼ˆå°è¯´ã€æ•£æ–‡ï¼‰
- å½±è§†ä½œå“å‰§æœ¬
- æ¸¸è®°ã€æ—…è¡Œæ–‡å­¦
- ä»»ä½•åŒ…å«åœ°ç‚¹æå†™çš„é•¿æ–‡æœ¬

### å®Œæ•´æµç¨‹
```
åŸå§‹å°è¯´æ–‡æœ¬
    â†“
[é˜¶æ®µ1] æ–‡æœ¬åˆ†ç‰‡ï¼ˆæŒ‰ç« èŠ‚ï¼‰
    â†“
[é˜¶æ®µ2] AI åœ°ç‚¹æŠ½å–ï¼ˆLLMï¼‰
    â†“
[é˜¶æ®µ3] æ•°æ®æ¸…æ´—ä¸åˆå¹¶
    â†“
[é˜¶æ®µ4] åœ°ç†ç¼–ç ï¼ˆè½¬ä¸ºç»çº¬åº¦ï¼‰
    â†“
[é˜¶æ®µ5] ç”Ÿæˆå†…å®¹åŒ…ï¼ˆContentPack JSONï¼‰
    â†“
éƒ¨ç½²åˆ° iOS åº”ç”¨
```

### ç›®å½•ç»“æ„çº¦å®š
```
é¡¹ç›®åç§°/
â”œâ”€â”€ 00_åŸå§‹å°è¯´/           # åŸå§‹æ–‡æœ¬
â”‚   â””â”€â”€ å°è¯´å.txt
â”œâ”€â”€ 01_åˆ†ç‰‡/               # æŒ‰ç« èŠ‚åˆ†ç‰‡
â”‚   â”œâ”€â”€ chunk_001.txt
â”‚   â”œâ”€â”€ chunk_002.txt
â”‚   â””â”€â”€ index.json
â”œâ”€â”€ 02_AIåˆ†æ/             # LLM æŠ½å–ç»“æœ
â”‚   â”œâ”€â”€ prompts.jsonl
â”‚   â””â”€â”€ extract_places.jsonl
â”œâ”€â”€ 03_AIæ±‡æ€»/             # æ¸…æ´—åˆå¹¶åçš„æ•°æ®
â”‚   â”œâ”€â”€ merged_places.json
â”‚   â””â”€â”€ cleaned_places.filtered.json
â”œâ”€â”€ 04_åœ°ç‚¹è§£æ/           # åœ°ç†ç¼–ç ç»“æœ
â”‚   â”œâ”€â”€ geocoded_places.json
â”‚   â””â”€â”€ logs/
â””â”€â”€ 05_å†…å®¹åŒ…/             # æœ€ç»ˆäº§ç‰©
    â””â”€â”€ content-pack.json
```

---

## é˜¶æ®µ 1ï¼šæ–‡æœ¬åˆ†ç‰‡

### ç›®çš„
å°†é•¿ç¯‡æ–‡æœ¬æŒ‰ç« èŠ‚åˆ†å‰²ï¼Œä¾¿äº LLM å¤„ç†ï¼ˆé¿å…è¶…å‡º token é™åˆ¶ï¼‰ã€‚

### æ“ä½œæ­¥éª¤

```bash
# 1. å‡†å¤‡åŸå§‹æ–‡æœ¬ï¼ˆUTF-8 ç¼–ç ï¼‰
# æ–‡ä»¶ä½ç½®ï¼š00_åŸå§‹å°è¯´/å°è¯´å.txt

# 2. è¿è¡Œåˆ†ç‰‡è„šæœ¬
python scripts/split_chapters.py \
  --text "00_åŸå§‹å°è¯´/å°è¯´å.txt" \
  --out-dir "01_åˆ†ç‰‡" \
  --per-chunk 2
```

### å‚æ•°è¯´æ˜
| å‚æ•° | è¯´æ˜ | å»ºè®®å€¼ |
|------|------|--------|
| `--text` | è¾“å…¥æ–‡ä»¶è·¯å¾„ | - |
| `--out-dir` | è¾“å‡ºç›®å½• | `01_åˆ†ç‰‡` |
| `--per-chunk` | æ¯ä¸ªåˆ†ç‰‡åŒ…å«çš„ç« èŠ‚æ•° | 1-3ï¼ˆé•¿ç« èŠ‚ç”¨1ï¼ŒçŸ­ç« èŠ‚ç”¨2-3ï¼‰ |

### è¾“å‡ºæ–‡ä»¶
- `01_åˆ†ç‰‡/chunk_001.txt` ~ `chunk_XXX.txt`
- `01_åˆ†ç‰‡/index.json`ï¼ˆç« èŠ‚ç´¢å¼•ï¼‰

### æ£€æŸ¥ç‚¹
- [ ] åˆ†ç‰‡æ•°é‡åˆç†ï¼ˆæ¯ä¸ªåˆ†ç‰‡çº¦ 3000-8000 å­—ï¼‰
- [ ] index.json åŒ…å«æ­£ç¡®çš„ç« èŠ‚å¯¹åº”å…³ç³»
- [ ] æ²¡æœ‰ä¸¢å¤±æ–‡æœ¬å†…å®¹

---

## é˜¶æ®µ 2ï¼šAI åœ°ç‚¹æŠ½å–

### ç›®çš„
ä½¿ç”¨ LLM ä»æ¯ä¸ªåˆ†ç‰‡ä¸­æŠ½å–åœ°ç‚¹ã€èŠ‚æ—¥ã€ç»„ç»‡ç­‰ä¿¡æ¯ã€‚

### æ­¥éª¤ 2.1ï¼šç”Ÿæˆæç¤ºè¯

```bash
python scripts/generate_prompts.py \
  --chunks "01_åˆ†ç‰‡" \
  --out "02_AIåˆ†æ/prompts.jsonl" \
  --template place
```

### æ­¥éª¤ 2.2ï¼šè¿è¡Œ LLM æŠ½å–

```bash
# è®¾ç½® API Key
export OPENAI_API_KEY="your-api-key"

# è¿è¡ŒæŠ½å–
python scripts/run_extraction.py \
  --prompts "02_AIåˆ†æ/prompts.jsonl" \
  --out "02_AIåˆ†æ/extracted/" \
  --model gpt-4 \
  --rate-limit 1.0
```

### æŠ½å–æç¤ºè¯æ¨¡æ¿ï¼ˆplaceï¼‰
```
ä½ æ˜¯ä¿¡æ¯æŠ½å–åŠ©æ‰‹ã€‚é˜…è¯»ç»™å®šæ–‡æœ¬åˆ†ç‰‡ï¼ŒæŠ½å–ä»¥ä¸‹è¦ç´ ï¼š
1) åœ°ç‚¹ï¼ˆplacesï¼‰ï¼šå°½é‡ç»™å‡ºæœ€å…·ä½“çš„åœ°åï¼Œä¿ç•™åŒä¹‰/åˆ«åã€‚
2) èŠ‚æ—¥ï¼ˆfestivalsï¼‰ï¼šå«åœ°åŸŸæ€§èŠ‚æ—¥/åº™ä¼šç­‰ã€‚
3) ç»„ç»‡ï¼ˆorganizationsï¼‰ï¼šå¦‚ä¼šåã€æœºæ„åç­‰ã€‚
4) å…³è”ï¼ˆlinksï¼‰ï¼šå°†èŠ‚æ—¥ä¸åœ°ç‚¹å…³è”ã€ç»„ç»‡ä¸åœ°ç‚¹å…³è”ã€‚

è¦æ±‚ï¼š
- å°½é‡ç»“æ„åŒ–è¾“å‡ºï¼›å­—æ®µä¸å­˜åœ¨æ—¶ç½® null
- quote æ§åˆ¶åœ¨ 120 å­—ä»¥å†…
- å¦‚æœæ— æ³•ç¡®å®šå‡†ç¡®åœ°ç‚¹ï¼Œä¹Ÿå¯å…³è”åˆ°ä¸Šçº§è¡Œæ”¿åŒº
```

### è¾“å‡ºæ ¼å¼
```json
{
  "places": [
    {
      "name": "åŒ—äº¬è¥¿ç«™",
      "alias": ["è¥¿å®¢ç«™"],
      "granularity": "poi",
      "evidence": {
        "offsetStart": 1234,
        "offsetEnd": 1256,
        "quote": "ä»–ä»åŒ—äº¬è¥¿ç«™å‡ºå‘..."
      }
    }
  ],
  "festivals": [...],
  "organizations": [...],
  "links": [...]
}
```

### æ£€æŸ¥ç‚¹
- [ ] æ‰€æœ‰åˆ†ç‰‡éƒ½å·²å¤„ç†
- [ ] è¾“å‡ºæ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ˆå¯è§£æçš„ JSONï¼‰
- [ ] æŠ½å–åˆ°çš„åœ°ç‚¹æ•°é‡åˆç†

---

## é˜¶æ®µ 3ï¼šæ•°æ®æ¸…æ´—ä¸åˆå¹¶

### ç›®çš„
- åˆå¹¶åŒååœ°ç‚¹
- æ¸…æ´—é‡å¤å’Œä½è´¨é‡æ•°æ®
- è¡¥å……ç»“æ„åŒ–åœ°å€

### æ­¥éª¤ 3.1ï¼šåˆå¹¶æŠ½å–ç»“æœ

```bash
python scripts/merge_places.py \
  --input-dir "02_AIåˆ†æ/extracted/" \
  --output "03_AIæ±‡æ€»/merged_places.json"
```

### æ­¥éª¤ 3.2ï¼šæ•°æ®æ¸…æ´—ï¼ˆå¯é€‰ LLM è¾…åŠ©ï¼‰

å¯¹äºå¤§å‹é¡¹ç›®ï¼Œå»ºè®®ä½¿ç”¨ LLM è¿›è¡ŒäºŒæ¬¡æ¸…æ´—ï¼š

```bash
python scripts/clean_places.py \
  --input "03_AIæ±‡æ€»/merged_places.json" \
  --output "03_AIæ±‡æ€»/cleaned_places.json" \
  --api-key "$OPENAI_API_KEY"
```

æ¸…æ´—å†…å®¹ï¼š
- åˆå¹¶ synopsisï¼ˆæ•…äº‹ç®€ä»‹ï¼‰
- æ ‡å‡†åŒ–åœ°å€æ ¼å¼ï¼ˆçœ-å¸‚-åŒº-è¡—é“-åœ°ç‚¹ï¼‰
- å»é™¤é‡å¤å’Œæ¨¡ç³Šåœ°ç‚¹

### æ­¥éª¤ 3.3ï¼šè¿‡æ»¤é—®é¢˜æ•°æ®

```bash
python scripts/filter_places.py \
  --input "03_AIæ±‡æ€»/cleaned_places.json" \
  --output "03_AIæ±‡æ€»/cleaned_places.filtered.json"
```

è¿‡æ»¤è§„åˆ™ï¼š
- ç§»é™¤åŒ…å«"æœªæä¾›"çš„åœ°å€
- ç§»é™¤åŒ…å«å¤šä¸ª"æŸ"å­—çš„æ¨¡ç³Šåœ°å€
- ç§»é™¤"ä¸­å›½-æŸ"å¼€å¤´çš„æ— æ•ˆåœ°å€

### è¾“å‡ºæ ¼å¼
```json
[
  {
    "title": "åŒ—äº¬è¥¿ç«™",
    "address": "åŒ—äº¬å¸‚-æµ·æ·€åŒº-è²èŠ±æ± ä¸œè·¯-åŒ—äº¬è¥¿ç«™",
    "synopsis": "ä¸»è§’ä»åŒ—äº¬è¥¿ç«™å‡ºå‘ï¼Œè¸ä¸Šäº†å†’é™©ä¹‹æ—…...",
    "source": {
      "chunks": ["chunk_001.txt", "chunk_045.txt"],
      "quotes": ["ä»–ä»åŒ—äº¬è¥¿ç«™å‡ºå‘...", "å†æ¬¡å›åˆ°è¥¿ç«™..."]
    }
  }
]
```

### æ£€æŸ¥ç‚¹
- [ ] åœ°å€æ ¼å¼ç»Ÿä¸€ï¼ˆçœ-å¸‚-åŒº-è¡—é“-åœ°ç‚¹ï¼‰
- [ ] æ— é‡å¤åœ°ç‚¹
- [ ] æ— æ˜æ˜¾é”™è¯¯æˆ–æ¨¡ç³Šæ•°æ®
- [ ] synopsis å†…å®¹å®Œæ•´

---

## é˜¶æ®µ 4ï¼šåœ°ç†ç¼–ç 

### ç›®çš„
å°†åœ°åè½¬æ¢ä¸ºç»çº¬åº¦åæ ‡ã€‚

### æ“ä½œæ­¥éª¤

```bash
# ä½¿ç”¨ Nominatimï¼ˆå…è´¹ï¼‰
python scripts/geocode_places.py \
  --input "03_AIæ±‡æ€»/cleaned_places.filtered.json" \
  --out "04_åœ°ç‚¹è§£æ/geocoded_places.json" \
  --cache "04_åœ°ç‚¹è§£æ/geocode_cache.json" \
  --validate

# æˆ–ä½¿ç”¨é«˜å¾·åœ°å›¾ APIï¼ˆæ›´å‡†ç¡®ï¼Œéœ€è¦ Keyï¼‰
export AMAP_KEY="your-amap-key"
python scripts/geocode_places.py \
  --input "03_AIæ±‡æ€»/cleaned_places.filtered.json" \
  --out "04_åœ°ç‚¹è§£æ/geocoded_places.amap.json" \
  --provider amap \
  --amap-key "$AMAP_KEY" \
  --validate
```

### éªŒè¯æœºåˆ¶
å¯ç”¨ `--validate` åä¼šè¿›è¡Œï¼š
1. **è¡Œæ”¿åŒºä¸€è‡´æ€§æ£€æŸ¥**ï¼šéªŒè¯è¿”å›çš„ locality ä¸æŸ¥è¯¢åœ°å€åŒ¹é…
2. **åæ ‡è·ç¦»æ£€æŸ¥**ï¼šéªŒè¯åæ ‡åœ¨åˆç†èŒƒå›´å†…

### å¤„ç†å¤±è´¥çš„ç¼–ç 
```bash
# å¯¼å‡ºç¼–ç å¤±è´¥çš„åœ°ç‚¹
python scripts/export_failed.py \
  --input "04_åœ°ç‚¹è§£æ/geocoded_places.json" \
  --output "04_åœ°ç‚¹è§£æ/failed_places.json"
```

å¤±è´¥çš„åœ°ç‚¹å¯ä»¥ï¼š
- æ‰‹åŠ¨ä¿®æ­£åæ ‡
- è°ƒæ•´åœ°å€æ ¼å¼åé‡è¯•
- æ ‡è®°ä¸ºéœ€è¦äººå·¥å®¡æ ¸

### æ£€æŸ¥ç‚¹
- [ ] ç¼–ç æˆåŠŸç‡ > 95%
- [ ] éªŒè¯é€šè¿‡ç‡ > 80%
- [ ] æ— æ˜æ˜¾çš„è·¨çœé”™è¯¯

---

## é˜¶æ®µ 5ï¼šç”Ÿæˆå†…å®¹åŒ…

### ç›®çš„
ç”Ÿæˆç¬¦åˆ Geolore ContentPack è§„èŒƒçš„ JSON æ–‡ä»¶ã€‚

### æ“ä½œæ­¥éª¤

```bash
python scripts/build_pack.py \
  --input "04_åœ°ç‚¹è§£æ/geocoded_places.json" \
  --out "05_å†…å®¹åŒ…/content-pack.json" \
  --pack-id "my-novel" \
  --title "æˆ‘çš„å°è¯´åœ°å›¾" \
  --version 1 \
  --tags "æ–‡å­¦" "å°è¯´"
```

### è¾“å‡ºæ ¼å¼ï¼ˆContentPack v1ï¼‰
```json
{
  "schemaVersion": 1,
  "pack": {
    "id": "my-novel",
    "version": 1,
    "title": "æˆ‘çš„å°è¯´åœ°å›¾",
    "locale": "zh-Hans",
    "applyMode": "merge"
  },
  "map": {
    "title": "æˆ‘çš„å°è¯´åœ°å›¾"
  },
  "places": [...],
  "mapPlaces": [...],
  "tags": ["curated", "æ–‡å­¦", "å°è¯´", "pack:my-novel@1"]
}
```

### éªŒè¯å†…å®¹åŒ…

```bash
python scripts/validate_pack.py \
  --input "05_å†…å®¹åŒ…/content-pack.json"
```

æ£€æŸ¥é¡¹ï¼š
- JSON æ ¼å¼æ­£ç¡®
- å¿…å¡«å­—æ®µå®Œæ•´
- places å’Œ mapPlaces æ•°é‡ä¸€è‡´
- æ‰€æœ‰ placeClientId å¼•ç”¨æœ‰æ•ˆ

### æ£€æŸ¥ç‚¹
- [ ] JSON æ ¼å¼æ­£ç¡®
- [ ] åœ°ç‚¹æ•°é‡ç¬¦åˆé¢„æœŸ
- [ ] æ‰€æœ‰å¿…å¡«å­—æ®µå®Œæ•´

---

## éƒ¨ç½²åˆ° iOS åº”ç”¨

### æ­¥éª¤ 1ï¼šå¤åˆ¶å†…å®¹åŒ…

```bash
cp "05_å†…å®¹åŒ…/content-pack.json" \
   "geolore/Resources/content-pack.json"
```

### æ­¥éª¤ 2ï¼šæ›´æ–° StoreScreenï¼ˆå¦‚éœ€è¦ï¼‰

åœ¨ `StoreScreen.swift` ä¸­æ·»åŠ æ–°çš„å†…å®¹åŒ…å¡ç‰‡ï¼š

```swift
contentPackCard(
    title: "æˆ‘çš„å°è¯´",
    subtitle: "ä½œè€…å",
    description: "å°è¯´ç®€ä»‹...",
    systemImage: "book.closed.fill",
    status: packStatus,
    isProcessing: isInstalling,
    action: installPack
)
```

### æ­¥éª¤ 3ï¼šæµ‹è¯•

1. åœ¨ Xcode ä¸­ç¼–è¯‘è¿è¡Œ
2. è¿›å…¥"é›†å¸‚"é¡µé¢
3. ç‚¹å‡»"è·å–"æŒ‰é’®å®‰è£…
4. éªŒè¯åœ°å›¾ä¸Šçš„åœ°ç‚¹æ˜¾ç¤ºæ­£ç¡®

---

## å¸¸è§é—®é¢˜

### Q1: LLM æŠ½å–çš„åœ°ç‚¹ä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ
- ä¼˜åŒ–æç¤ºè¯ï¼Œå¢åŠ ç¤ºä¾‹
- ä½¿ç”¨æ›´å¼ºå¤§çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰
- äººå·¥å®¡æ ¸å’Œä¿®æ­£

### Q2: åœ°ç†ç¼–ç å¤±è´¥ç‡é«˜æ€ä¹ˆåŠï¼Ÿ
- æ£€æŸ¥åœ°å€æ ¼å¼æ˜¯å¦è§„èŒƒ
- ä½¿ç”¨åˆ†çº§å›é€€ç­–ç•¥
- å°è¯•ä¸åŒçš„ç¼–ç æœåŠ¡ï¼ˆNominatim / é«˜å¾·ï¼‰

### Q3: å¦‚ä½•å¤„ç†åŒååœ°ç‚¹ï¼Ÿ
- åœ¨åœ°å€ä¸­åŠ å…¥ä¸Šçº§è¡Œæ”¿åŒº
- ä½¿ç”¨æ›´å…·ä½“çš„ POI åç§°
- å¯ç”¨éªŒè¯æœºåˆ¶è¿‡æ»¤é”™è¯¯åŒ¹é…

### Q4: å†…å®¹åŒ…å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ
- æ‹†åˆ†ä¸ºå¤šä¸ªå†…å®¹åŒ…
- å‹ç¼© JSONï¼ˆç§»é™¤ç©ºç™½ï¼‰
- ç²¾ç®€ synopsis é•¿åº¦

---

## é™„å½•ï¼šå·¥å…·é€ŸæŸ¥è¡¨

| é˜¶æ®µ | è„šæœ¬ | ç”¨é€” |
|------|------|------|
| 1 | `split_chapters.py` | æ–‡æœ¬åˆ†ç‰‡ |
| 2 | `generate_prompts.py` | ç”Ÿæˆæç¤ºè¯ |
| 2 | `run_extraction.py` | LLM æŠ½å– |
| 3 | `merge_places.py` | åˆå¹¶åœ°ç‚¹ |
| 3 | `clean_places.py` | æ¸…æ´—æ•°æ® |
| 3 | `filter_places.py` | è¿‡æ»¤é—®é¢˜æ•°æ® |
| 4 | `geocode_places.py` | åœ°ç†ç¼–ç  |
| 5 | `build_pack.py` | ç”Ÿæˆå†…å®¹åŒ… |
| 5 | `validate_pack.py` | éªŒè¯å†…å®¹åŒ… |
